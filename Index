<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMM - Sistema de Informa칞칚o de Mortalidade Municipal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sensitive-data { transition: all 0.3s ease; }
        .anonymized .sensitive-data {
            filter: blur(5px);
            user-select: none;
            color: transparent;
        }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <!-- Modal de Configura칞칚o Inicial -->
    <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">Configura칞칚o do Sistema</h2>
            <p class="text-gray-600 mb-6 text-sm">Por favor, identifique a localidade de opera칞칚o do SIMM.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Munic칤pio</label>
                    <input type="text" id="munInput" placeholder="Ex: S칚o Paulo" class="mt-1 w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Estado (UF)</label>
                    <select id="ufInput" class="mt-1 w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="AC">Acre</option><option value="AL">Alagoas</option><option value="AP">Amap치</option>
                        <option value="AM">Amazonas</option><option value="BA">Bahia</option><option value="CE">Cear치</option>
                        <option value="DF">Distrito Federal</option><option value="ES">Esp칤rito Santo</option><option value="GO">Goi치s</option>
                        <option value="MA">Maranh칚o</option><option value="MT">Mato Grosso</option><option value="MS">Mato Grosso do Sul</option>
                        <option value="MG">Minas Gerais</option><option value="PA">Par치</option><option value="PB">Para칤ba</option>
                        <option value="PR">Paran치</option><option value="PE">Pernambuco</option><option value="PI">Piau칤</option>
                        <option value="RJ">Rio de Janeiro</option><option value="RN">Rio Grande do Norte</option><option value="RS">Rio Grande do Sul</option>
                        <option value="RO">Rond칪nia</option><option value="RR">Roraima</option><option value="SC">Santa Catarina</option>
                        <option value="SP">S칚o Paulo</option><option value="SE">Sergipe</option><option value="TO">Tocantins</option>
                    </select>
                </div>
                <button id="saveConfig" class="w-full bg-blue-700 text-white font-bold py-2 rounded-lg hover:bg-blue-800 transition">Entrar no Sistema</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-blue-700 text-white shadow-lg no-print">
        <div class="container mx-auto px-4 py-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold flex items-center">
                    SIMM <span id="headerLoc" class="ml-2 text-blue-200 font-light text-xl"></span>
                </h1>
                <p class="text-sm opacity-80">Vigil칙ncia Epidemiol칩gica de 칍bitos</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button id="toggleAnonymize" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition text-sm font-medium border border-red-400">Modo LGPD: Ativo</button>
                <button id="exportCSV" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg transition text-sm font-medium">Exportar CSV</button>
                <button onclick="window.print()" class="bg-white text-blue-700 hover:bg-gray-100 px-4 py-2 rounded-lg transition text-sm font-medium">Imprimir</button>
                <button id="resetConfig" class="text-xs opacity-50 hover:opacity-100 underline ml-2">Alterar Localidade</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Se칞칚o de Formul치rio -->
        <section class="bg-white rounded-xl shadow-md p-6 mb-8 no-print border-t-4 border-blue-600">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2 flex items-center">
                <span class="mr-2">游닇</span> Novo Registro de 칍bito
            </h2>
            <form id="deathForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">N췈 da DO</label>
                    <input type="text" id="doNumber" required class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nome Completo (Sens칤vel)</label>
                    <input type="text" id="fullName" required class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">CPF (Sens칤vel)</label>
                    <input type="text" id="cpf" required placeholder="000.000.000-00" class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Data do 칍bito</label>
                    <input type="date" id="deathDate" required class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Causa Prim치ria (CID-10)</label>
                    <input type="text" id="cause" required placeholder="Ex: I21.9" class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Local</label>
                    <select id="locationType" class="mt-1 w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="Hospital">Hospital</option>
                        <option value="Domic칤lio">Domic칤lio</option>
                        <option value="Via P칰blica">Via P칰blica</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="md:col-span-3 flex justify-end">
                    <button type="submit" class="bg-blue-700 hover:bg-blue-800 text-white px-8 py-2 rounded-lg font-bold transition shadow-md">Salvar Registro</button>
                </div>
            </form>
        </section>

        <!-- Tabela -->
        <section class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <span class="mr-2">游늵</span> Lista de 칍bitos <span id="tableLoc" class="ml-2 text-gray-500 text-sm italic"></span>
                </h2>
                <span id="recordCount" class="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full">0 Registros</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse" id="deathTable">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-xs">
                            <th class="p-4 border-b">DO</th>
                            <th class="p-4 border-b">Nome</th>
                            <th class="p-4 border-b">CPF</th>
                            <th class="p-4 border-b">Data</th>
                            <th class="p-4 border-b">Causa</th>
                            <th class="p-4 border-b">Local</th>
                            <th class="p-4 border-b no-print">A칞칫es</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-gray-700"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // Carrega os registos e a configura칞칚o do armazenamento local (browser)
        let records = JSON.parse(localStorage.getItem('simm_records')) || [];
        let config = JSON.parse(localStorage.getItem('simm_config')) || null;
        let isAnonymized = true;

        const setupModal = document.getElementById('setupModal');
        const headerLoc = document.getElementById('headerLoc');
        const tableLoc = document.getElementById('tableLoc');

        // Fun칞칚o para verificar se o munic칤pio j치 foi configurado
        function checkConfig() {
            if (!config) {
                setupModal.classList.remove('hidden');
            } else {
                setupModal.classList.add('hidden');
                headerLoc.textContent = `| ${config.municipio} - ${config.uf}`;
                tableLoc.textContent = `(${config.municipio}/${config.uf})`;
                renderTable();
            }
        }

        // Grava a configura칞칚o de Munic칤pio e Estado
        document.getElementById('saveConfig').addEventListener('click', () => {
            const mun = document.getElementById('munInput').value;
            const uf = document.getElementById('ufInput').value;
            if (mun && uf) {
                config = { municipio: mun, uf: uf };
                localStorage.setItem('simm_config', JSON.stringify(config));
                checkConfig();
            } else {
                alert("Por favor, preencha o Munic칤pio e o Estado.");
            }
        });

        // Permite resetar a configura칞칚o de localidade
        document.getElementById('resetConfig').addEventListener('click', () => {
            if(confirm("Deseja alterar a localidade do sistema? Isto reiniciar치 a p치gina.")) {
                localStorage.removeItem('simm_config');
                location.reload();
            }
        });

        // Ativa/Desativa o modo de prote칞칚o de dados (LGPD)
        document.getElementById('toggleAnonymize').addEventListener('click', function() {
            isAnonymized = !isAnonymized;
            document.body.classList.toggle('anonymized', isAnonymized);
            this.textContent = isAnonymized ? "Modo LGPD: Ativo" : "Modo LGPD: Inativo";
            this.className = isAnonymized 
                ? "bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition text-sm font-medium border border-red-400"
                : "bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg transition text-sm font-medium border border-gray-400";
        });

        // Submiss칚o do formul치rio de 칩bito
        document.getElementById('deathForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newRecord = {
                id: Date.now(),
                do: document.getElementById('doNumber').value,
                name: document.getElementById('fullName').value,
                cpf: document.getElementById('cpf').value,
                date: document.getElementById('deathDate').value,
                cause: document.getElementById('cause').value,
                location: document.getElementById('locationType').value
            };
            records.push(newRecord);
            localStorage.setItem('simm_records', JSON.stringify(records));
            renderTable();
            e.target.reset();
        });

        // Remove um registo da lista
        function deleteRecord(id) {
            if(confirm("Deseja realmente excluir este registro?")) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('simm_records', JSON.stringify(records));
                renderTable();
            }
        }

        // Atualiza a tabela no ecr칚
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            document.getElementById('recordCount').textContent = `${records.length} Registro(s)`;
            
            // Ordena por data (mais recente primeiro)
            records.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 border-b transition";
                row.innerHTML = `
                    <td class="p-4 font-mono text-sm">${r.do}</td>
                    <td class="p-4 sensitive-data">${r.name}</td>
                    <td class="p-4 sensitive-data text-xs">${r.cpf}</td>
                    <td class="p-4">${new Date(r.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    <td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">${r.cause}</span></td>
                    <td class="p-4">${r.location}</td>
                    <td class="p-4 no-print text-center">
                        <button onclick="deleteRecord(${r.id})" class="text-red-500 hover:scale-110 transition font-medium">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Exporta칞칚o para CSV (compat칤vel com Excel) incluindo Munic칤pio e Estado
        document.getElementById('exportCSV').addEventListener('click', () => {
            if (records.length === 0) return alert("N칚o existem dados para exportar.");
            let csv = "Munic칤pio,UF,DO,Nome,CPF,Data,Causa,Local\n";
            records.forEach(r => {
                csv += `${config.municipio},${config.uf},${r.do},${r.name},${r.cpf},${r.date},${r.cause},${r.location}\n`;
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `SIMM_${config.municipio}_${config.uf}.csv`;
            link.click();
        });

        // Inicia o sistema
        window.onload = () => {
            checkConfig();
            document.body.classList.add('anonymized');
        };
    </script>
</body>
</html>
